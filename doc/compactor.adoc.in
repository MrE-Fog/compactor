= compactor(1)
Sinodun Internet Technologies
:manmanual: DNS-STATS
:mansource: DNS-STATS
:man-linkstyle: blue R <>

== NAME

compactor - capture DNS traffic and write query/response pair information to file

== SYNOPSIS

*compactor* ['OPTIONS']... ['FILE'...]

== DESCRIPTION

*compactor* reads DNS traffic, extracts query and response messages and matches
these into query/response pairs. Information on these pairs is written to output file.
Optionally other output files may be written containing all packets, or packets not used
in the matching process. These output files are in PCAP format.

If any input files are specified, *compactor* reads from each input file in turn. The input
files must be in PCAP format. Reading an input file requires no special privileges.

If no input files are specified, but a network interface device is
specified, *compactor* will capture packets from that interface until
interrupted by a SIGINT signal (e.g. from control-C) or a SIGTERM
signal (e.g. generated by the *kill*(1) command).

If a SIGHUP signal is received during network interface capture, *compactor* will
stop the current collection, re-read the configuration file and restart data collection
using updated settings. Only configuration items previously unspecified or taken
from the configuration file can be updated; items specified on the command line
cannot be changed. During restart there will be a brief interval during which packets
are not recorded.

Reading packets from a network interface may require that you have
special privileges; see the *pcap*(3PCAP) man page for details.

*compactor* will report an error if no input file or network interface device is
specified.

*compactor* may also be built with support for DNSTAP. In this case, *compactor*
supports either reading data from DNSTAP capture files, or for capturing traffic
directly from a name server over a Unix socket.

== OPTIONS

Options to *compactor* are command options or configuration options.

include::user-guide/compactor-command-options.adoc[]

=== Configuration options

Configuration options may be given on the command line, or may be specified in a
configuration file. The same option may be given in a configuration file and also on the
command line, in which case the command line option value is used.

A configuration file is a plain text file with lines in the form `option=value`. A `#`
character introduces a comment that spans until the end of the line.

In a configuration file, the long form of the option name must be used. So, for
example, to set the snap length to 64, the configuration file entry must read
`snaplen=64`. `s=64` will not be accepted.

The `excludesfile` option cannot be specified in the configuration file.

include::user-guide/compactor-capture-from-network.adoc[]

include::user-guide/compactor-capture-from-dnstap.adoc[]

include::user-guide/compactor-outputs.adoc[]

include::user-guide/compactor-query-response-matching.adoc[]

== OUTPUT FILE PATTERNS

The paths used for all types of file output are described with output
patterns. An output pattern can include expansions introduced by a `%`
character in the filename part of the path (i.e. the last component -
you can't have expansions in a directory name). `%%` adds a single `%`
character to the output path.

Two categories of expansions are available, time expansions and configuration
expansions. Time expansions are of the form `%` followed by a single letter, and
expand to a time component determined by the letter. For a list of the available letters,
see *strftime*(3). Time expansions must be included in the output file pattern for
filename based rotation to occur using the *rotation-period* option.

Configuration expansions are of the form `%{name}`, and substitute the value of the
configuration item named. The configuration items that may be substituted are
*interface*, *rotate-period*, *snaplen*, *query-timeout*, *skew-timeout*, and
*promiscuous-mode*. *interface* substitutes the names of all configured
interfaces separated by *-* . The first network interface can be substituted as
*interface1* , a second network interface (if configured) can be substituted
as *interface2*, and so on. Similarly, *vlan-id* substitutes all configured VLAN IDs
separated by *-*. The first VLAN ID can be substituted as *vlan1*, *vland-id2*
substitutes the second VLAN ID if configured, and so on.

== EXCLUDED FIELDS

To minimise the size of output files, _compactor_ can omit fields that are not required
by the user. The fields to be omitted are specified by an exclude file. This file
can be specified using the `excludesfile` option. If not given, the
default configuration file `@ETCPATH@/excluded_fields.conf`
is read if present.

The fields that can be omitted are divided into different categories.
By default all fields are included in the output.
To omit a field from the output, specify the field name in the exclude file in the
appropriate category section.

Category `[ip-header]`:

*time-offset* ::
  Time offset of a query/response record from the start of capture. Used to
  construct the query timestamp.
*response-delay* ::
  The time difference between query and response. Used to reconstruct the
  response timestamp.
*client-address* ::
  The IP address of the DNS client.
*client-port* ::
  The port used by the DNS client.
*client-hoplimit* ::
  The IPv4 TTL or IPv6 hoplimit of the query.
*server-address* ::
  The IP address of the DNS server.
*server-port* ::
  The port used by the DNS server.
*qr-transport-flags* ::
  Details on the query and response transport - IP version, UDP/TCP etc.

Category `[dns-header]`:

*transaction-id* ::
  The DNS transaction ID of the query/response.
*query-opcode* ::
  The DNS OPCODE of the query.
*query-rcode* ::
  The DNS RCODE of the query.
*dns-flags* ::
  The DNS flags of the query and response.
*response-rcode* ::
  The DNS RCODE of the response.
*query-qdcount* ::
  The QDCOUNT of the query.
*query-ancount* ::
  The ANCOUNT of the query.
*query-arcount* ::
  The ARCOUNT of the query.
*query-nscount* ::
  The NSCOUNT of the query.

Category `[dns-payload]`:

*query-name* ::
  The QNAME of the first Question section of the query.
*query-class-type* ::
  The TYPE and CLASS of the query.
*rr-ttl* ::
  The TTL in any Resource Record (RR) in the response.
*rr-rdata* ::
  The RDATA in any Resource Record (RR) in the response.
*query-udp-size* ::
  Query EDNS sender's maximum acceptable UDP message size.
*query-edns-version* ::
  Query EDNS version.
*query-opt-data* ::
  Data part of Query OPT.
*query-question-sections* ::
  Second and subsequent Question QRRs in query.
*query-answer-sections* ::
  Answer RRs in query.
*query-authority-sections* ::
  Authority RRs in query.
*query-additional-sections* ::
  Additional RRs in query.
*response-answer-sections* ::
  Answer RRs in response.
*response-authority-sections* ::
  Authority RRs in response.
*response-additional-sections* ::
  Additional RRs in response.

Category `[dns-meta-data]`:

*query-size* ::
  Size of query DNS message.
*response-size* ::
  Size of response DNS message.

Category `[storage-meta-data]`:
*address-events* ::
  Address events.

== OUTPUT FILE SECTIONS

The main output of DNS Query/Response pair information can optionally include
full details on sections of the DNS messages.

The sections to include are specified with the `include` option.
This option is deprecated, and will be removed in a future release. It is replaced by
the `excludesfile` option. See the user guide for more information.
`include` can only be specified if no `excludesfile` is read.
In that case, no section details are included except for those sections
specified using the `include` option.

The `include` option can be given multiple times. The sections that can
be included are:

*query-questions*::
  Include second and subsequent QUESTION sections from queries. The first
  QUESTION section is always recorded.

*query-answers*::
  Include ANSWERS data from queries.

*query-authority*::
  Include AUTHORITY data from queries.

*query-additional*::
  Include ADDITIONAL data from queries.

*query-all*::
  Include all sections from queries.

*response-questions*::
  Include second and subsequent QUESTION sections from responses. The first
  QUESTION section is always recorded.

*response-answers*::
  Include ANSWERS data from responses.

*response-authority*::
  Include AUTHORITY data from responses.

*response-additional*::
  Include ADDITIONAL data from responses.

*response-all*::
  Include all sections from queries.

*all*::
  Include all sections from both queries and responses.

== EXIT STATUS

The exit status is 1 if any error occurred. A successful run ends with an exit status of 0.

== RESOURCES

https://github.com/dns-stats/compactor/wiki

== COPYRIGHT

Copyright 2016-2019 Internet Corporation for Assigned Names and Numbers.

Free use of this software is granted under the terms of the Mozilla Public
Licence, version 2.0. See the source for full details.
